<!doctype html>
<html>

<head>
    <link rel="stylesheet" href="style.css">
    <title>Pacman</title>
    <link rel="icon" href="pacman.png"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!--<script src="algorythems.js"></script>
    <script src="max.js"></script>-->
    <script>
        var FPS = 100;

        var boardText = [
            "#############################################",
            "#..........r..........#.........s...........#",
            "#.###.###############...###############.###.#",
            "#.###.................#v...........d....###.#",
            "#.###.########.#####.###.#####.########.###.#",
            "#.###.########.#####.###.#####.########.###.#",
            "#..............#####.###.#####..............#",
            "#.###.########.#####%###.#####.########.###.#",
            "#.###.########.#####.###.#####.########.###.#",
            "#.###.................#.................###.#",
            "#.###.###############.#.###############.###.#",
            "#...........................................#",
            "#############################################"
        ];


        var board;

        function Entity(board, row, col, icon) {
            this.board = board
            this.x = col;
            this.y = row
            this.icon = icon;

            this.vx = 1;
            this.vy = 0;

            Entity.prototype.move = function () {}
            Entity.prototype.bewegeRichtung = function (x, y) {
                this.vx = x;
                this.vy = y;
                var tmpX = this.x + this.vx;
                var tmpY = this.y + this.vy;
                if (this.board.cells[tmpY][tmpX] != "#") {
                    this.x += this.vx;
                    this.y += this.vy;
                } else {
                    this.vx = 0;
                    this.vy = 0;
                }
            }
        }

        function Board(boardText) {
            this.score = 0;

            //2d array with element for each cell on board
            this.cells = [];

            this.width = boardText[0].length;
            this.height = boardText.length;

            this.entities = [];
            this.player;
            this.lastKeyEvent = "";

            var boardDiv = document.getElementById("boardDiv");


            var tmp = "<table>";

            //convert the boar to a 2d array
            for (r = 0; r < this.height; r++) {
                tmp += "<tr>";
                this.cells[r] = new Array();
                for (c = 0; c < this.width; c++) {
                    var t = boardText[r].substr(c, 1);
                    if (t == "#" || t == ".") {
                        //wall or coin
                    } else if (t == "%") {
                        this.player = new Entity(this, r, c, "pacman.png");
                        this.player.move = movePacman;
                        this.entities.push(this.player);
                        t = " ";
                    } else {
                        //assume monster
                        var m = new Entity(this, r, c, "monster.png");

                        if (t == "r") {
                            m.move = moveRight;
                        } else if (t == "l") {
                            m.move = moveLeft;
                        } else if (t == "d") {
                            m.move = moveRandom;
                            m.icon = "monster-blue.png"
                        } else if (t == "v") {
                            m.move = selbeCord;
                            m.icon = "monster-green.png"
                        } else if (t == "s") {
                            m.move = sicht;
                            m.icon = "monster-orange.png"
                        }


                        this.entities.push(m);
                        t = ".";
                    }
                    this.cells[r][c] = t;
                    tmp += "<td id=\"" + r + "-" + c + "\"/>";
                }
                tmp += "</tr>";
            }

            tmp += "</table>";
            boardDiv.innerHTML = tmp;

            for (i in this.entities) {
                var m = this.entities[i];
                var cell = $("#" + m.y + "-" + m.x);
                cell.html("<img src='" + m.icon + "'/>");
            }

            Board.prototype.drawBoard = function () {
                for (r = 0; r < this.height; r++) {
                    for (c = 0; c < this.width; c++) {
                        var cellDiv = $("#" + r + "-" + c);
                        if (this.cells[r][c] == "#") {
                            cellDiv.css("background-color", "blue");
                        } else if (this.cells[r][c] == ".") {
                            cellDiv.html("<img src='coin.png'/>");
                        } else {
                            cellDiv.html(this.cells[r][c]);
                        }
                    }
                }

                for (i in this.entities) {
                    var m = this.entities[i];
                    var cell = $("#" + m.y + "-" + m.x);
                    cell.html("<img src='" + m.icon + "'/>");
                }


                statsDiv.innerHTML = "";
                statsDiv.innerHTML += "score:" + this.score + "<br/>";
                statsDiv.innerHTML += "w:" + this.width + "<br/>";
                statsDiv.innerHTML += "h:" + this.height + "<br/>";
                statsDiv.innerHTML += "lastKeyEvent:" + this.lastKeyEvent.keyCode + "<br/>";
                statsDiv.innerHTML += "pacmanNextVX:" + pacmanNextVX + "<br/>";
                statsDiv.innerHTML += "pacmanNextVY:" + pacmanNextVY + "<br/>";
                statsDiv.innerHTML += "entities:" + this.entities.length + "<br/>";

                for (i in this.entities) {
                    var m = this.entities[i];
                    statsDiv.innerHTML += "<div id='" + i + "' class='statsdiv'></div>";
                    var tmp = "Entity " + i + ":<br/>";
                    tmp += "icon :" + "<img src='" + m.icon + "'/><br/>";
                    tmp += "vx: " + m.vx + "<br/>";
                    tmp += "vy: " + m.vy + "<br/>";
                    tmp += "x: " + m.x + "<br/>";
                    tmp += "y: " + m.y + "<br/>";
                    //statsDiv.innerHTML += "<br/>";
                    $("#" + i).html(tmp);
                }

            }

            Board.prototype.move = function () {
                for (i in this.entities) {
                    this.entities[i].move(this.entities[i]);
                }
                //check if hit by monster

            }

        }


        var moveLeftRight = function (entity, dir) {
            var r = entity.y + entity.vy;
            var c = entity.x + entity.vx;

            var t = entity.board.cells[r][c];
            if (t != ' ' && t != '.') {
                if (entity.vx != 0) {
                    entity.vy = entity.vx * dir;
                    entity.vx = 0;
                } else {
                    entity.vx = -(entity.vy * dir);
                    entity.vy = 0;
                }
                entity.move(entity);
            } else {
                entity.y = r;
                entity.x = c;
            }
        }

        ///////////////////////////////////////////
        //            Algorythmen                //
        ///////////////////////////////////////////

        function moveRight(entity) {
            moveLeftRight(entity, 1);
        }

        function moveLeft(entity) {
            moveLeftRight(entity, -1);
        }

        function moveRandom(entity) {
            if (Math.floor(Math.random() * 2) == 0) {
                moveLeftRight(entity, -1);
            } else {
                moveLeftRight(entity, 1);
            }

        }

        function sicht(m) {
            sichtX = m.x
            sichtY = m.y

            try {
                //if (m.x != m.board.player.x && m.y != m.board.player.y) {
                    while (m.board.cells[sichtY][sichtX] != "#") {
                        if (sichtX == m.board.player.x && sichtY == m.board.player.y) {
                            throw [1, 0];
                        }
                        sichtX++;
                    }
                    sichtX = m.x
                    sichtY = m.y
                    while (m.board.cells[sichtY][sichtX] != "#") {
                        if (sichtX == m.board.player.x && sichtY == m.board.player.y) {
                            throw [-1, 0];
                        }

                        sichtX--;
                    }
                    sichtX = m.x
                    sichtY = m.y
                    while (m.board.cells[sichtY][sichtX] != "#") {
                        if (sichtX == m.board.player.x && sichtY == m.board.player.y) {
                            throw [0, 1];
                        }
                        sichtY++;
                    }
                    sichtX = m.x
                    sichtY = m.y
                    while (m.board.cells[sichtY][sichtX] != "#") {
                        if (sichtX == m.board.player.x && sichtY == m.board.player.y) {
                            throw [0, -1];
                        }
                        sichtY--;
                    }
                //}
                moveRandom(m);
            } catch (err) {
                m.bewegeRichtung(err[0], err[1]);
            }
        }

        function selbeCord(m) {
            if (m.cooldown) {
                player = m.board.player;
                if (m.x < player.x) {
                    m.bewegeRichtung(1, 0);
                } else if (m.x > player.x) {
                    m.bewegeRichtung(-1, 0);
                }

                if (m.y < player.y) {
                    m.bewegeRichtung(0, 1);
                } else if (m.y > player.y) {
                    m.bewegeRichtung(0, -1);
                }
            }
            m.cooldown = !m.cooldown;

        }



        ///////////////////////////////////////////

        var movePacman = function () {
            var r = this.y + pacmanNextVY;
            var c = this.x + pacmanNextVX;

            var t = board.cells[r][c];
            if (t == ' ' || t == '.') {
                this.vx = pacmanNextVX;
                this.vy = pacmanNextVY;
                this.y = r;
                this.x = c;
            } else {
                r = this.y + this.vy;
                c = this.x + this.vx;
                t = board.cells[r][c];

                if (t == ' ' || t == '.') {
                    this.y = r;
                    this.x = c;
                } else {
                    this.vx = 0;
                    this.vy = 0;
                }

            }
            if (t == '.') {
                board.cells[r][c] = ' ';
                board.score += 100;
            }

        }

        var pacmanNextVX = 0;
        var pacmanNextVY = 0;

        function keyboardHandler(e) {
            board.lastKeyEvent = e;
            if (e.keyCode == '38') {
                // up arrow
                pacmanNextVX = 0;
                pacmanNextVY = -1;
            } else if (e.keyCode == '40') {
                // down arrow
                pacmanNextVX = 0;
                pacmanNextVY = 1;
            } else if (e.keyCode == '37') {
                // left arrow
                pacmanNextVX = -1;
                pacmanNextVY = 0;
            } else if (e.keyCode == '39') {
                // right arrow
                pacmanNextVX = 1;
                pacmanNextVY = 0;
            }

        }

        document.onkeydown = keyboardHandler;

        function pacmanInit() {
            /*$("#FPSsel").change(function(){
                            console.log($("#FPSsel").val());
                            $("#FPSval").html($("#FPSsel").val());
            });*/
            board = new Board(boardText);
            board.drawBoard();

            function loop() {
                board.move();
                board.drawBoard();
                var FPS = Math.round(9.5*$("#FPSsel").val()+50);
                $("#FPSval").html(Math.round(1000/FPS));
                //FPS = $("#FPSsel").val();
                setTimeout(loop, FPS);


            }
            setTimeout(loop, FPS);
        }

        $(document).ready(pacmanInit);
    </script>
</head>

<body>
    <div id="controles" class="controles">
        <b>Controles</b>
        <br>
        <br>
        <label for="FPS">FPS</label>
        <input id="FPSsel" value="0" type="range" max="50" min="0" name="FPS">
        <div id="FPSval">100</div>
        <br>
        <input type=button>
    </div>
    <div id="boardDiv">

    </div>

    <div id="statsDiv">

    </div>

</body>

</html>